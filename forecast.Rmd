---
title: "Burkina Faso Weather Forecast"
author: "Derek Morr"
date: "5/24/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries, message=FALSE, warning=FALSE, include=FALSE}
library(terra)
library(tmap)
library(sf)
library(stars)
```

# Constants

First, we define some constants.

```{r}
shp_file <- "shp/bfa_admbnda_adm2_igb_20200323.shp"
forecast_input_tiff <- "plot_ensemble_median_total_rainfall.tiff"
output_filename <- "12 au 11 juin 2022 - tmap.png"
```


# Crop the GeoTIFF

First, we crop the forecast GeoTIFF to Burkina Faso. We use the 
[R terra package](https://rspatial.github.io/terra/) to do this.

```{r}
forecast <- rast(forecast_input_tiff)
boundaries <- vect(shp_file)

# name of a temp file
bf_map_cropped <- "forecast-cropped.tif"

# crop the forecast GeoTIFF to BFA boundaries
bfa_forecast <- terra::crop(forecast, boundaries, snap = "out")
bfa_forecast <- terra::mask(bfa_forecast, boundaries)

# save a temp copy of the cropped GeoTIFF for tmap
terra::writeRaster(bfa_forecast, bf_map_cropped, overwrite = TRUE)

rm(boundaries, forecast, bfa_forecast)
```

# TMAP

The [tmap package](https://r-tmap.github.io/tmap/) has many tools for making 
beautiful maps programatically.

Unfortunately, `tmap` does not yet support the `terra` data directly.
That's why we had to save the temporary copy of the cropped GeoTIFF.
First, we have to load in the data again.

```{r include=FALSE}
boundaries <- st_read(shp_file)
bfa_forecast <- read_stars(bf_map_cropped)
```

Now we build the map using `tmap`.

A note on styling. I chose a built-in blue-scale color palette and quantile
styling. This was a quick way to approximate the original map from Romaric.
If this is not acceptable, we can adjust the `style = "quantile"` argument 
to adjust the raster styling. We can also manually set breaks and a palette.

```{r}
map <- tm_shape(bfa_forecast) + 
  tm_raster(
    title = "Quantités de pluie",
    palette = "Blues",
    style = "quantile"
  ) +
tm_shape(boundaries) +
  tm_borders() +
  tm_text(
    text = "ADM2_FR",
    col = "red",
    size = 0.6
  ) +
  #tm_scale_bar() +
  tm_compass(
    type = "rose",
    show.labels = 2,
    position = c("left", "top"),
    size = 4
  ) +
  tm_graticules(alpha = 0) +
  tm_layout(
    main.title = "Total pluviométrique du 12 Mai 2022 au 11 Juin 2022",
    main.title.fontface = "bold",
    main.title.position = "center",
    legend.position = c("right", "bottom"),
    inner.margins = 0.06
  )
```

Manually inspect the map:

```{r}
map
```

Save it to a file:

```{r}
tmap_save(map, output_filename)
```

